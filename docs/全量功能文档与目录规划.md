# SeaTunnelX 全量功能文档与目录规划（开发+运维版）

---

## 2. 系统角色与进程

SeaTunnelX 由 4 类核心进程构成：

1. Control Plane API（后端 HTTP + 可选 gRPC Server）
2. Frontend（Next.js 页面层）
3. Scheduler（定时任务调度）
4. Worker（异步任务消费）

此外还有独立部署在目标主机上的 `seatunnelx-agent`，通过 gRPC 与 Control Plane 通信。

---

## 3. 代码目录说明（当前真实结构）

### 3.1 根目录核心

- `main.go`：后端启动入口（Cobra 命令分发）。
- `config.example.yaml`：后端配置模板。
- `internal/`：后端核心代码。
- `frontend/`：前端应用。
- `agent/`：独立 Agent 模块（独立 Go module）。
- `scripts/`：`proto`/`swagger`/`tidy`/`license` 脚本。
- `docs/`：文档与 Swagger 产物。
- `lib/`：安装包/Agent 二进制等运行时资产目录（由功能逻辑引用）。

### 3.2 后端模块（`internal/apps`）

已覆盖的功能域如下：

- `auth`：账号密码登录、会话鉴权
- `oauth`：GitHub/Google OAuth
- `health`：健康检查
- `dashboard`：统计与运维概览
- `host`：主机管理
- `cluster`：集群与节点管理
- `discovery`：主机进程发现/导入
- `monitor`：监控配置与进程事件
- `installer`：安装包、预检查、安装流程
- `plugin`：插件市场与集群插件
- `config`：配置中心（模板/版本/回滚/推送）
- `audit`：命令日志与审计日志
- `admin`：用户管理、项目审核
- `task`：任务中心 API（当前为内存管理器）
- `agent`：Agent 分发（install/uninstall/download）
- `deepwiki`：文档拉取与搜索
- `project`：项目分发类功能（保留模块，API仍可用）

### 3.3 前端页面入口（`frontend/app`）

- `/login`：登录
- `/callback`：OAuth 回调
- `/dashboard`：概览仪表盘
- `/hosts`：主机管理
- `/hosts/:id`：主机详情
- `/clusters`：集群管理
- `/clusters/:id`：集群详情（节点、配置、监控、插件）
- `/packages`：安装包管理
- `/plugins`：插件市场
- `/audit-logs`：审计日志
- `/admin/users`：管理员用户管理
- `/commands`：命令日志页面（存在页面，导航默认隐藏）

---

## 4. 文档目录规划（建议）

建议将 `docs/` 按“快速入门 + 功能手册 + 运维手册 + API 参考”拆分：

```text
docs/
  README.md
  00-快速开始.md
  01-架构与进程模型.md
  02-配置说明.md
  03-部署指南.md
  04-Agent部署与运维.md
  05-前端使用手册.md
  06-后端功能手册.md
  07-API总览.md
  08-排障手册.md
  modules/
    auth.md
    oauth.md
    host.md
    cluster.md
    installer.md
    plugin.md
    config.md
    monitor.md
    audit.md
    admin.md
    task.md
    deepwiki.md
    project.md
```

本文件可作为 `06-后端功能手册.md + 07-API总览.md` 的初始合并版本。

---

## 5. 快速使用（用户视角）

## 5.1 本地启动

1. 复制配置：

```bash
cp config.example.yaml config.yaml
```

2. 启动后端 API：

```bash
go mod tidy
go run main.go api
```

3. 启动前端：

```bash
cd frontend
pnpm install
pnpm dev
```

4. 访问前端：`http://localhost:3000`

默认管理员（首次初始化）：`admin / admin123`（以 `config.yaml` 为准）。

## 5.2 定时任务（可选）

当你需要定时任务和异步消费时，分别启动：

```bash
go run main.go scheduler
go run main.go worker
```

说明：`scheduler/worker` 依赖 Redis 作为 Asynq Broker，请先在配置中启用 Redis 并确保可连通。

## 5.3 Agent 启动（目标主机）

方式 1：从平台获取安装命令（推荐）

- 前端进入“主机详情”复制安装命令
- 或调用 `GET /api/v1/hosts/:id/install-command`

方式 2：手工启动

```bash
seatunnelx-agent -c /path/to/agent-config.yaml
```

最小 Agent 配置示例：

```yaml
agent:
  id: ""
control_plane:
  addresses:
    - "127.0.0.1:9000"
  tls:
    enabled: false
  token: ""
heartbeat:
  interval: 10s
log:
  level: "info"
  file: "/var/log/seatunnelx-agent/agent.log"
seatunnel:
  install_dir: "/opt/seatunnel"
```

---

## 6. 功能清单（全覆盖）与使用方式

下表覆盖当前代码中所有功能域（按模块）：

| 模块 | 前端入口 | API 前缀 | 用户怎么用 |
|---|---|---|---|
| 健康检查 | 无 | `/health` | 运维探活直接调用健康接口。 |
| 账号登录 | `/login` | `/auth/*` | 用户名密码登录、查看当前用户、退出登录。 |
| OAuth 登录 | `/login` + `/callback` | `/oauth/*` | 启用 GitHub/Google 后，走 OAuth 登录回调。 |
| 仪表盘统计 | `/dashboard` | `/dashboard/stats/all` | 看业务统计。 |
| 运维概览 | `/dashboard` | `/dashboard/overview/*` | 看主机/集群/节点/活动概览。 |
| 主机管理 | `/hosts`, `/hosts/:id` | `/hosts/*` | 新增主机、编辑、删除、获取 Agent 安装命令。 |
| 主机发现 | `/hosts/:id` 对话框 | `/hosts/:id/discover*` | 在目标主机扫描已运行 SeaTunnel 进程并导入。 |
| 集群管理 | `/clusters`, `/clusters/:id` | `/clusters/*` | 创建集群、增删节点、启停集群与节点、看节点日志。 |
| 监控配置 | `/clusters/:id` | `/clusters/:id/monitor-config` | 配置自动监控/自动重启策略。 |
| 进程事件 | `/clusters/:id` | `/clusters/:id/events*` | 查询进程启动/崩溃/重启事件与统计。 |
| 安装包管理 | `/packages` | `/packages/*` | 在线刷新版本、下载、上传离线包、删除本地包。 |
| 主机安装流程 | `/hosts/:id` 安装向导 | `/hosts/:id/precheck`, `/install*` | 执行预检查、启动安装、查看进度、重试/取消。 |
| 插件市场 | `/plugins` | `/plugins/*` | 下载插件到控制面，配置依赖。 |
| 集群插件管理 | `/clusters/:id` | `/clusters/:id/plugins*` | 集群级安装/卸载/启停插件，查看进度。 |
| 配置中心 | `/clusters/:id` | `/clusters/:id/configs*`, `/configs/*` | 初始化配置、编辑、版本、回滚、模板同步、推送节点。 |
| 命令日志 | `/commands`（导航隐藏） | `/commands/*` | 查看下发命令的执行记录与详情。 |
| 审计日志 | `/audit-logs` | `/audit-logs/*` | 查看用户行为审计记录。 |
| 管理员用户管理 | `/admin/users` | `/admin/users/*` | 管理员增删改查用户。 |
| 管理员项目审核 | 无（API 可用） | `/admin/projects*` | 审核项目状态。 |
| 任务中心 API | 无（API 可用） | `/tasks/*`, `/hosts/:id/tasks` | 创建任务、启动、取消、重试、查询。 |
| Agent 分发 | 无（给目标主机） | `/agent/install.sh`, `/download` | 给目标主机提供安装脚本和 Agent 包下载。 |
| DeepWiki 文档服务 | 可通过功能入口/API | `/deepwiki/*` | 获取 SeaTunnel 文档、按仓库拉取、搜索。 |
| Project 模块（保留） | 暂无主导航 | `/projects/*`, `/tags` | 项目创建、领取、举报、标签和历史。 |

---

## 7. 全量 API 路由清单（按域分组）

统一前缀：`/api/v1`

## 7.1 公共与认证

- `GET /health`
- `POST /auth/login`
- `POST /auth/logout`
- `GET /auth/user-info`
- `GET /oauth/providers`
- `GET /oauth/login`
- `POST /oauth/callback`

## 7.2 Host（主机）

- `POST /hosts`
- `GET /hosts`
- `GET /hosts/:id`
- `PUT /hosts/:id`
- `DELETE /hosts/:id`
- `GET /hosts/:id/install-command`
- `POST /hosts/:id/discover`
- `POST /hosts/:id/discover/confirm`
- `POST /hosts/:id/discover-processes`
- `GET /hosts/:id/tasks`
- `POST /hosts/:id/precheck`
- `POST /hosts/:id/install`
- `GET /hosts/:id/install/status`
- `POST /hosts/:id/install/retry`
- `POST /hosts/:id/install/cancel`

## 7.3 Cluster（集群与节点）

- `POST /clusters`
- `GET /clusters`
- `GET /clusters/:id`
- `PUT /clusters/:id`
- `DELETE /clusters/:id`
- `POST /clusters/:id/nodes`
- `GET /clusters/:id/nodes`
- `PUT /clusters/:id/nodes/:nodeId`
- `DELETE /clusters/:id/nodes/:nodeId`
- `POST /clusters/:id/nodes/precheck`
- `POST /clusters/:id/nodes/:nodeId/start`
- `POST /clusters/:id/nodes/:nodeId/stop`
- `POST /clusters/:id/nodes/:nodeId/restart`
- `GET /clusters/:id/nodes/:nodeId/logs`
- `POST /clusters/:id/start`
- `POST /clusters/:id/stop`
- `POST /clusters/:id/restart`
- `GET /clusters/:id/status`

## 7.4 Monitor（监控）

- `GET /clusters/:id/monitor-config`
- `PUT /clusters/:id/monitor-config`
- `GET /clusters/:id/events`
- `GET /clusters/:id/events/stats`

## 7.5 Installer/Package（安装）

- `GET /packages`
- `POST /packages/versions/refresh`
- `GET /packages/:version`
- `POST /packages/upload`
- `DELETE /packages/:version`
- `POST /packages/download`
- `GET /packages/downloads`
- `GET /packages/download/:version`
- `POST /packages/download/:version/cancel`

## 7.6 Plugin（插件）

- `GET /plugins`
- `GET /plugins/local`
- `GET /plugins/downloads`
- `POST /plugins/download-all`
- `GET /plugins/:name`
- `POST /plugins/:name/download`
- `GET /plugins/:name/download/status`
- `DELETE /plugins/:name/local`
- `GET /plugins/:name/dependencies`
- `POST /plugins/:name/dependencies`
- `DELETE /plugins/:name/dependencies/:depId`
- `GET /clusters/:id/plugins`
- `POST /clusters/:id/plugins`
- `DELETE /clusters/:id/plugins/:name`
- `PUT /clusters/:id/plugins/:name/enable`
- `PUT /clusters/:id/plugins/:name/disable`
- `GET /clusters/:id/plugins/:name/progress`

## 7.7 Config（配置中心）

- `GET /clusters/:id/configs`
- `POST /clusters/:id/configs/init`
- `POST /clusters/:id/configs/sync-all`
- `GET /configs/:id`
- `PUT /configs/:id`
- `GET /configs/:id/versions`
- `POST /configs/:id/rollback`
- `POST /configs/:id/promote`
- `POST /configs/:id/sync`
- `POST /configs/:id/push`

## 7.8 Audit/Command（日志）

- `GET /commands`
- `GET /commands/:id`
- `GET /audit-logs`
- `GET /audit-logs/:id`

## 7.9 Admin（管理员）

- `GET /admin/projects`
- `PUT /admin/projects/:id/review`
- `GET /admin/users`
- `POST /admin/users`
- `GET /admin/users/:id`
- `PUT /admin/users/:id`
- `DELETE /admin/users/:id`

## 7.10 Task（任务中心）

- `POST /tasks`
- `GET /tasks`
- `GET /tasks/:id`
- `POST /tasks/:id/start`
- `POST /tasks/:id/cancel`
- `POST /tasks/:id/retry`

## 7.11 Agent Distribution（Agent 分发）

- `GET /agent/install.sh`
- `GET /agent/uninstall.sh`
- `GET /agent/download`

## 7.12 DeepWiki

- `GET /deepwiki/docs`
- `POST /deepwiki/fetch`
- `POST /deepwiki/search`

## 7.13 Project（保留模块）

- `GET /projects/mine`
- `GET /projects`
- `POST /projects`
- `PUT /projects/:id`
- `DELETE /projects/:id`
- `GET /projects/:id/receivers`
- `POST /projects/:id/receive`
- `POST /projects/:id/report`
- `GET /projects/received`
- `GET /projects/:id`
- `GET /tags`

---

## 8. 典型用户操作流程（可直接照做）

## 8.1 新主机上线并纳入集群

1. 在 `/hosts` 新增主机（`bare_metal` 填 IP/SSH 端口）。
2. 在主机详情获取安装命令并到目标机执行，确认 Agent 在线。
3. 在 `/clusters` 创建集群，进入集群详情新增节点并预检查。
4. 通过安装向导安装 SeaTunnel。
5. 安装后在集群详情执行启动，查看节点状态与日志。

## 8.2 离线安装

1. 在 `/packages` 上传离线安装包。
2. 在主机详情安装向导选择离线模式与目标版本。
3. 执行预检查 -> 安装 -> 查看步骤状态。

## 8.3 配置变更与回滚

1. 在集群详情进入配置中心，初始化配置（从某节点拉取）。
2. 编辑并保存（生成版本历史）。
3. 必要时回滚到历史版本。
4. 推广配置（Promote）并同步至全部节点。

## 8.4 插件管理

1. 在 `/plugins` 按版本浏览插件并下载到控制面。
2. 按需添加依赖（dependencies）。
3. 在集群详情安装插件到集群节点。
4. 用启用/禁用接口控制插件状态。

## 8.5 监控与审计

1. 在集群详情配置自动监控/自动重启策略。
2. 通过事件列表观察崩溃、重启、失败记录。
3. 在 `/audit-logs` 查看操作审计，在 `/commands` 查看命令执行链路。

---

## 9. gRPC 与 Agent（运维重点）

Control Plane gRPC（默认端口 `9000`）提供：

- `Register`
- `Heartbeat`
- `CommandStream`
- `LogStream`

Agent 支持的核心命令类型包括：

- 预检查：`PRECHECK`
- 安装生命周期：`INSTALL` `UNINSTALL` `UPGRADE`
- 进程操作：`START` `STOP` `RESTART` `STATUS`
- 诊断：`COLLECT_LOGS` `JVM_DUMP` `THREAD_DUMP`
- 配置：`UPDATE_CONFIG` `ROLLBACK_CONFIG` `PULL_CONFIG`
- 插件：`TRANSFER_PLUGIN` `INSTALL_PLUGIN` `UNINSTALL_PLUGIN` `LIST_PLUGINS`
- 安装包传输：`TRANSFER_PACKAGE`
- 发现与监控：`DISCOVER_CLUSTERS` `UPDATE_MONITOR_CONFIG`

---

## 10. 常用研发/运维命令

## 10.1 后端

```bash
go run main.go api
go run main.go scheduler
go run main.go worker
go test ./...
```

## 10.2 前端

```bash
cd frontend
pnpm dev
pnpm test
pnpm lint
```

## 10.3 生成与检查

```bash
make tidy
make swagger
make proto
make check_license
make pre_commit
```

---

## 11. 配置关键项（必须关注）

- `app.external_url`：必须是目标主机可访问地址，用于 Agent 安装脚本生成。
- `grpc.enabled/port`：Agent 通信开关与端口。
- `grpc.heartbeat_interval` 与 `grpc.heartbeat_timeout`：离线判定关键。
- `redis.enabled`：会话与任务链路依赖开关（任务链路建议启用）。
- `storage.*`：安装包、插件、临时文件目录。
- `database.type`：`sqlite/mysql/postgres`。

前端开发联调常用变量：

- `NEXT_PUBLIC_BACKEND_BASE_URL`（默认 `http://localhost:8000`）
- `NEXT_PUBLIC_FRONTEND_BASE_URL`（默认 `http://localhost:3000`）

---

## 12. 完整性声明（本文件覆盖范围）

本文件已覆盖以下全量能力域：

1. 全部前端页面入口
2. 全部 `internal/apps/*` 功能模块
3. 全部主路由注册 API
4. Agent 分发与 gRPC 协议能力
5. Scheduler/Worker 异步任务能力
6. 启动、部署、配置、排障关键路径


